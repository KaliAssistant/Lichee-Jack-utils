#!/bin/sh
#
# BATTERY - Li-ion battery voltage and percentage reader
#
# Reads raw ADC values from the SAR ADC device and converts
# them into a human-readable battery percentage and voltage.
#
# Output format:
#   <percentage>%@<voltage>v
#   e.g. 78%@3.9123v
#
# ADC characteristics:
#   - Range: 0–4095
#   - Voltage: 0–4.6V
#
# Uses a realistic Li-ion discharge curve approximation
# rather than linear scaling.
#
#
# SPDX-License-Identifier: GPL-3.0
#
# Copyright (C) 2025 KaliAssistant
# Author: KaliAssistant
#
# This file is part of the Lichee-Jack project.
# It is free software: you may redistribute and/or modify it under
# the terms of the GNU General Public License v3.0 or later.
#

ADC_DEV="/dev/cvi-saradc0"
MAX_ADC=4095
MAX_VOLT=4.6

# Optional: select ADC channel
echo 1 > "$ADC_DEV" 2>/dev/null

RAW=$(cat "$ADC_DEV" 2>/dev/null)
[ -z "$RAW" ] && { echo "0%@0.0000v"; exit 1; }

# Convert raw ADC to voltage
VOLT=$(awk -v raw="$RAW" -v max_adc="$MAX_ADC" -v max_v="$MAX_VOLT" 'BEGIN { printf "%.4f", raw * max_v / max_adc }')

# Realistic Li-ion voltage-to-percentage curve (approximation)
awk -v v="$VOLT" '
function pct(v) {
    if (v >= 4.200) return 100;
    else if (v >= 4.150) return 95;
    else if (v >= 4.100) return 90;
    else if (v >= 4.050) return 85;
    else if (v >= 4.000) return 80;
    else if (v >= 3.950) return 75;
    else if (v >= 3.900) return 70;
    else if (v >= 3.850) return 65;
    else if (v >= 3.800) return 60;
    else if (v >= 3.750) return 55;
    else if (v >= 3.700) return 50;
    else if (v >= 3.650) return 45;
    else if (v >= 3.600) return 40;
    else if (v >= 3.550) return 35;
    else if (v >= 3.500) return 30;
    else if (v >= 3.450) return 25;
    else if (v >= 3.400) return 20;
    else if (v >= 3.350) return 15;
    else if (v >= 3.300) return 10;
    else if (v >= 3.250) return 5;
    else if (v >= 3.000) return 1;
    else return 0;
}
BEGIN {
    p = pct(v);
    printf "%d%%@%.4fv\n", p, v;
}'

