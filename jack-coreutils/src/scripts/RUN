#!/bin/bash
#
# RUN - Payload execution dispatcher for Lichee-Jack
#
# This script prepares the payload execution environment and
# launches payloads based on the selected mode:
#
#   MOD1 : Execute payload from /root/payloads.d/mod1.d
#   MOD2 : Execute payload from /root/payloads.d/mod2.d
#   FILE : Execute a user-specified payload file
#
# Supported payload formats:
#   - payload.py   (executed with python3)
#   - payload.sh   (executed with bash)
#   - payload      (raw executable script)
#
# The script also:
#   - Verifies payload and loot directories
#   - Creates /root/loot.d if missing
#   - Signals fatal errors via LED patterns
#
# This tool is typically invoked by jackstart.
#
#
# SPDX-License-Identifier: GPL-3.0
#
# Copyright (C) 2025 KaliAssistant
# Author: KaliAssistant
#
# This file is part of the Lichee-Jack project.
# It is free software: you may redistribute and/or modify it under
# the terms of the GNU General Public License v3.0 or later.
#

ARG=$1

LOG="logger -t LicheeJack [*]"
LOG_ERR="logger -t LicheeJack -p 3 [!]"
$LOG "Prepping PAYLOAD environment..."

pre_check() {
    if [ ! -d /root/payloads.d/mod1.d ] || [ ! -d /root/payloads.d/mod2.d ]; then
        $LOG_ERR "Cannot find payloads directory! stop."
        /usr/bin/LED -c FF0000 -lbs 500000
        exit 1
    fi

    if [ ! -d /root/loot.d ]; then
        $LOG "LOOT directory not found. creating /root/loot.d ... "
        mkdir -p /root/loot.d
    fi
}

case $ARG in
    "MOD1")
          pre_check
          payload=$(find "/root/payloads.d/mod1.d"/payload* 2>/dev/null | tail -n1)
          case $(basename "${payload}") in
              "payload.py")
                  $LOG "Running payload \`${payload}\` (python3)"
                  python3 "${payload}" > /dev/null 2>&1
                  ;;
              "payload" | "payload.sh" | "payload.txt")
                  sed -i 's/\r//g' "${payload}"
                  $LOG "Running payload \`${payload}\` (bash)"
                  bash -C "${payload}" > /dev/null 2>&1
                  ;;
              *)
                  $LOG_ERR "Cannot find any executable payloads in /root/payloads.d/mod1.d !"
                  /usr/bin/LED -c FF0000 -lbs 500000
                  exit 1
                  ;;
          esac
          ;;
    "MOD2")
          pre_check
          payload=$(find "/root/payloads.d/mod2.d"/payload* 2>/dev/null | tail -n1)
          case $(basename "${payload}") in
              "payload.py")
                  $LOG "Running payload \`${payload}\` (python3)"
                  python3 "${payload}" > /dev/null 2>&1
                  ;;
              "payload" | "payload.sh" | "payload.txt")
                  sed -i 's/\r//g' "${payload}"
                  $LOG "Running payload \`${payload}\` (bash)"
                  bash -C "${payload}" > /dev/null 2>&1
                  ;;
              *)
                  $LOG_ERR "Cannot find any executable payloads in /root/payloads.d/mod2.d !"
                  /usr/bin/LED -c FF0000 -lbs 500000
                  exit 1
                  ;;
          esac
          ;;
    *)
          $LOG "Specified payload mode!"
          if [ ! -e $ARG ]; then
              $LOG_ERR "The specified payload \`${ARG}\` does not exist ! stop."
              /usr/bin/LED -c FF0000 -lbs 500000
              exit 1
          fi
          $LOG "Running specified payload \`${ARG}\` (executable file)"
          bash -C "${ARG}" > /dev/null 2>&1
          ;;
esac
